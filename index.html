<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Entrepreneur CEFIE</title>
  <link rel="icon" href="/assets/images/logo.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    html, body {
      height: 100%;
      margin: 0;
      background: #000;
    }

    #map {
      height: 100%;
      position: relative;
    }


   /* HEADER GENERAL */
header {
  position: fixed;
  top: 0; left: 0; right: 0;
  background: #111;
  color: white;
  display: flex;
  align-items: center;
  padding: 0 15px;
  z-index: 3000;
  box-shadow: 0 2px 5px rgba(0,0,0,0.7);
  gap: 15px;
  height: 50px;
}

header .title {
  display: flex;
  align-items: center;
}

header .title img {
  height: 100px;         /* PC altura grande */
  aspect-ratio: 3/1;     /* Forzar recorte rectangular */
  object-fit: cover;     /* Recorte interno */
  display: block;
}

header input[type="search"] {
  flex-grow: 1;
  height: 30px;
  border-radius: 5px;
  border: none;
  padding: 0 10px;
  font-size: 1rem;
}

header input[type="search"]:focus {
  outline: 2px solid #3498db;
}

/* RESPONSIVE MOBILE */
@media (max-width: 768px) {
  header {
    flex-direction: column;
    align-items: center;  /* Centra todo horizontal */
    height: auto;
    padding: 10px 15px;
  }

  header .title {
    justify-content: center;
    width: 100%;
    margin-bottom: 10px;
  }

  header .title img {
    height: 50px;         /* ALTURA para móvil */
    width: auto;
  }

  header input[type="search"] {
    width: 100%;
    flex-grow: 0;
  }
}


 /* Marcadores */

    #legend {
      position: absolute;
      bottom: 20px;
      left: 20px;
      background: #222;
      color: #fff;
      padding: 10px;
      border-radius: 5px;
      font-family: sans-serif;
      z-index: 1000;
      cursor: pointer;
      user-select: none;
    -webkit-user-select: none; /* Safari */
    -moz-user-select: none;    /* Firefox */
    -ms-user-select: none;     /* IE/Edge */
    }

    #legend div {
      margin-bottom: 4px;
      cursor: pointer;
    }

    #legend div:hover {
      background: #333;
    }

    #legend div.active {
      background: #444;
    }
  </style>
</head>
<body>

<header>
  <div class="title">
    <img src="/assets/images/textTRP.svg" alt="Logo">
  </div>
  <input id="searchInput" type="search" placeholder="Buscar producto..." />
</header>



  <div id="map"></div>

<div id="legend">
  <div id="legend-header" style="cursor: pointer;" draggable="false">
    <strong>Marcadores (minimizar)</strong><br><br>
  </div>
  <div id="legend-content">
    <div data-cat="emprendedores">
      <span style="display:inline-block;width:12px;height:12px;background:#3498db;margin-right:5px;" draggable="false"></span> Emprendedor
    </div>
    <div data-cat="clientes">
      <span style="display:inline-block;width:12px;height:12px;background:#e74c3c;margin-right:5px;" draggable="false"></span> Cliente
    </div>
    <div data-cat="proveedores">
      <span style="display:inline-block;width:12px;height:12px;background:#2ecc71;margin-right:5px;" draggable="false"></span> Proveedor
    </div>
    <div data-cat="premium">
      <span style="display:inline-block;width:12px;height:12px;background:#f1c40f;margin-right:5px;" draggable="false"></span> Premium
    </div>
    <hr style="border: 0; border-top: 1px solid #555;">
    <div data-cat="all"><strong>Mostrar Todos</strong></div>
  </div>
</div>


<!-- pop up json -->


<!-- Modal HTML -->
<div id="customModal" style="
  display: none; 
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.7);
  z-index: 3500;
  justify-content: center;
  align-items: center;
">
  <div style="
    background: #fff;
    color: #000;
    padding: 20px;
    border-radius: 8px;
    max-width: 90%;
    max-height: 90%;
    overflow: auto;
    position: relative;
  ">
    <button id="closeModal" style="
      position: absolute;
      top: 10px;
      right: 10px;
      border: none;
      background: #333;
      color: #fff;
      padding: 5px 10px;
      cursor: pointer;
    ">Cerrar</button>
    <div id="modalContent"></div>
  </div>
</div>


<!-- css productos json -->

<style>
.productos-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
}

.producto {
  border: 1px solid #ccc;
  padding: 10px;
}

.producto img {
  aspect-ratio: 1/1;
  width: 100%;
  max-width: 200px;
  display: block;
  object-fit: cover; 
}


@media (min-width: 768px) {
  .productos-grid {
    grid-template-columns: repeat(2, 1fr);
  }
}

/* iconos mapa */
.icon-premium {
  opacity: 0.7;
  border-radius: 50%; /* 👈 Obliga forma circular */
  object-fit: cover;  /* 👈 Recorta internamente */
}

/* botones modal */

.buttons-container {
  display: flex;
  gap: 10px;
  flex-direction: row; /* Por defecto lado a lado */
}

@media (max-width: 600px) {
  .buttons-container {
    flex-direction: column; /* En móviles uno arriba del otro */
  }
}


</style>

<!-- SCRIPT PRODUCTOS -->

<script>

//Modal interor pop up

  function openModal(nombre, tipo, detalle, perfil, producto, facebook, ig) {
  const modal = document.getElementById('customModal');
  const modalContent = document.getElementById('modalContent');
  modalContent.innerHTML = `
    <div style="
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      max-height: 80vh;
      overflow-y: auto;
      align-items: start;
    ">
      <div>
        <h2>${producto}</h2>
        <h3>${nombre}</h3>
        <p><strong>Tipo:</strong> ${tipo}</p>
        <p>${detalle}</p>
      </div>
      <div style="
        position: sticky;
        top: 50%;
        transform: translateY(-50%);
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
        align-items: center;
        max-height: 80vh;
        overflow: hidden;
      ">
        <img src="${perfil}" alt="Perfil" style="
          max-width: 100%;
          max-height: 300px;
          border-radius: 50%;
          object-fit: cover;
          margin-bottom: 10px;
        ">
        <div style="font-weight: bold; margin-bottom: 15px; text-align: center;">${nombre}</div>
        <div class="buttons-container">
          <a href="${facebook}" style="
            background-color: #3b5998;
            color: white;
            padding: 8px 12px;
            border-radius: 5px;
            text-decoration: none;
            font-weight: bold;
            font-family: sans-serif;
          " target="_blank" rel="noopener noreferrer">Facebook</a>
          <a href="${ig}" style="
            background-color: #e4405f;
            color: white;
            padding: 8px 12px;
            border-radius: 5px;
            text-decoration: none;
            font-weight: bold;
            font-family: sans-serif;
          " target="_blank" rel="noopener noreferrer">Instagram</a>
        </div>
      </div>
    </div>
  `;
  modal.style.display = 'flex';
}






    document.getElementById('closeModal').addEventListener('click', () => {
    document.getElementById('customModal').style.display = 'none';
  });
</script>




<!-- SCRIP COLAPSAR -->


<script>
  const legend = document.getElementById('legend');
  const legendHeader = document.getElementById('legend-header');
  const legendContent = document.getElementById('legend-content');

  legendHeader.addEventListener('click', () => {
    if (legendContent.style.display === 'none') {
      legendContent.style.display = 'block';
    } else {
      legendContent.style.display = 'none';
    }
  });
</script>

<!-- SCRIP COLAPSAR -->



<!-- SCRIP MAPA -->


<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
  // boton + y - mapa
  const map = L.map('map', { zoomControl: false }).setView([13.720195, -89.204076], 17);
  L.control.zoom({ position: 'bottomright' }).addTo(map);


  L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
    maxZoom: 19,
    attribution: '© OpenStreetMap contributors, © CartoDB'
  }).addTo(map);

  // Función para calcular metros por pixel en el zoom actual y latitud dada
  function metrosPorPixelEnZoom(zoom, lat) {
    const earthCircumference = 40075000; // metros en el ecuador
    const latRad = lat * Math.PI / 180;
    return earthCircumference * Math.cos(latRad) / (256 * Math.pow(2, zoom));
  }

  const categorias = {
    emprendedores: {
      color: '#3498db',
      radius: 10,
      archivo: 'emprendedores.json',
      layerGroup: L.layerGroup().addTo(map)
    },
    clientes: {
      color: '#e74c3c',
      radius: 10,
      archivo: 'clientes.json',
      layerGroup: L.layerGroup().addTo(map)
    },
    proveedores: {
      color: '#2ecc71',
      radius: 10,
      archivo: 'proveedores.json',
      layerGroup: L.layerGroup().addTo(map)
    },
    premium: {
      color: '#f1c40f',
      radius: 40,
      archivo: 'premium.json',
      layerGroup: L.layerGroup().addTo(map)
    }
  };

// CONFIGURACION MARCADORES

Object.keys(categorias).forEach(cat => {
  const config = categorias[cat];
  fetch(config.archivo)
    .then(res => res.json())
    .then(puntos => {
      puntos.forEach(punto => {

        if (cat === 'premium') {
          const radiusMeters = config.radius || 50;
          let metersPerPixel = metrosPorPixelEnZoom(map.getZoom(), punto.lat);
          let iconSize = radiusMeters / metersPerPixel * 2;

          const createIcon = size => L.divIcon({
            className: 'icon-premium',
            html: `
              <svg width="${size}" height="${size}" viewBox="0 0 100 100"
                xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
                style="opacity:0.85;">
                <defs>
                  <clipPath id="circleView">
                    <circle cx="50" cy="50" r="48" />
                  </clipPath>
                </defs>
                <image xlink:href="${punto.icono}"
                  x="0" y="0" width="100" height="100"
                  preserveAspectRatio="xMidYMid slice"
                  clip-path="url(#circleView)"/>
                <circle cx="50" cy="50" r="48"
                  fill="none" stroke="${config.color}" stroke-width="4"/>
              </svg>
            `,
            iconSize: [size, size],
            iconAnchor: [size / 2, size / 2]
          });

          let marker = L.marker([punto.lat, punto.lng], { icon: createIcon(iconSize) })
            .bindPopup(`
              <div style="display: flex; align-items: center;">
                <img src="${punto.perfil}" alt="Perfil" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover; margin-right: 10px;">
                <div>
                  <h3 style="margin: 0; font-weight: 700; color: ${config.color};">${punto.producto}</h3>
                  <p style="margin: 2px 0 6px; font-weight: 500; font-size: 1.1em;">${punto.nombre}</p>
                  <p style="margin: 0; font-style: italic; color: #aaa;">Tipo: ${cat}</p><br>
                  <button onclick="openModal('${punto.nombre}', '${cat}', \`${punto.detalle}\`, '${punto.perfil}', '${punto.producto}', '${punto.facebook}', '${punto.ig}')">Maximizar</button>
                </div>
              </div>
            `)
            .addTo(config.layerGroup)
            //centrar en mapa
            .on('click', () => {
            map.setView([punto.lat, punto.lng], map.getZoom(), { animate: true });
          });

            // MARCADOR PARA BUSCADOR
            config.markers = config.markers || [];

            // Guarda referencia
            config.markers.push({ marker, punto });


          map.on('zoom', () => {
            const metersPerPixelNow = metrosPorPixelEnZoom(map.getZoom(), punto.lat);
            const newSize = radiusMeters / metersPerPixelNow * 2;
            marker.setIcon(createIcon(newSize));
          });

        } else if (cat === 'clientes') {
  const radiusMeters = 10;  // tamaño radio en metros fijo para clientes
  let metersPerPixel = metrosPorPixelEnZoom(map.getZoom(), punto.lat);
  let iconSize = radiusMeters / metersPerPixel * 2;

  const createClienteIcon = size => L.divIcon({
    className: 'icon-cliente',
    html: `
      <svg width="${size}" height="${size}" viewBox="0 0 100 100"
        xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
        style="opacity:0.85;">
        <defs>
          <clipPath id="circleViewCliente">
            <circle cx="50" cy="50" r="48" />
          </clipPath>
        </defs>
        <image xlink:href="${punto.icono}"
          x="0" y="0" width="100" height="100"
          preserveAspectRatio="xMidYMid slice"
          clip-path="url(#circleViewCliente)"/>
        <circle cx="50" cy="50" r="48"
          fill="none" stroke="red" stroke-width="4"/>
      </svg>
    `,
    iconSize: [size, size],
    iconAnchor: [size / 2, size / 2]
  });

  let marker = L.marker([punto.lat, punto.lng], { icon: createClienteIcon(iconSize) })
    .bindPopup(`
    <div style="width: 250px;">
      <div style="display: flex; align-items: center; margin-bottom: 10px;">
        <div style="
          width: 50px; height: 50px; border-radius: 50%;
          overflow: hidden; border: 3px solid red; flex-shrink: 0; margin-right: 10px;">
          <img src="${punto.perfil}" alt="Perfil" style="width: 100%; height: 100%; object-fit: cover;">
        </div>
        <h3 style="margin: 0; color: red;">${punto.nombre}</h3>
      </div>
      <p style="font-style: italic; color: #555;">${punto.producto}</p>
      <div id="chatHistory" style="max-height: 150px; overflow-y: auto; border: 1px solid #ccc; padding: 5px; margin: 10px 0; font-size: 0.9em;"></div>
      <textarea id="chatInput" rows="2" style="width: 100%; resize: none;" placeholder="Escribe tu mensaje..."></textarea>
      <button id="sendChatBtn" style="margin-top: 5px; width: 100%; padding: 8px; background: red; color: white; border: none; border-radius: 5px; cursor: pointer;">
        Enviar
      </button>
    </div>
  `)

    .addTo(config.layerGroup)
    //centrar en mapa
    .on('click', () => {
    map.setView([punto.lat, punto.lng], map.getZoom(), { animate: true });
  })
    

    // script fake chat
    .on("popupopen", function(e) {
      const popupNode = e.popup.getElement();
      const btn = popupNode.querySelector("#sendChatBtn");
      const input = popupNode.querySelector("#chatInput");
      const historyDiv = popupNode.querySelector("#chatHistory");

      const storageKey = `chat_${punto.nombre}`;

      let historial = JSON.parse(localStorage.getItem(storageKey)) || punto.mensajes || [];

      const palabrasProhibidas = ["droga", "marihuana", "cocaína", "sexo", "porno", "adulto", "violación", "arma", "cocaina", "explosivo", "terrorista"];

      function contieneProhibidas(mensaje) {
        const lower = mensaje.toLowerCase();
        return palabrasProhibidas.some(p => lower.includes(p));
      }

      function renderHistorial() {
        historyDiv.innerHTML = historial.map(m => `
          <div style="display: flex; align-items: center; margin-bottom: 5px;">
            <img src="${m.perfil}" alt="${m.usuario}" style="width: 30px; height: 30px; border-radius: 50%; object-fit: cover; margin-right: 8px;">
            <div><strong>${m.usuario}:</strong> ${m.mensaje}</div>
          </div>
        `).join('');
      }

  renderHistorial();

  btn.addEventListener("click", () => {
    const mensaje = input.value.trim();
    if (mensaje === "") return;

    // 🚫 Verificar lista personalizada primero
    if (contieneProhibidas(mensaje)) {
      alert("Tu mensaje contiene palabras prohibidas por la tienda.");
      return;
    }

    // 🚫 Verificar con Purgomalum después
    fetch(`https://www.purgomalum.com/service/containsprofanity?text=${encodeURIComponent(mensaje)}`)
      .then(res => res.text())
      .then(isProfane => {
        if (isProfane === "true") {
          alert("Tu mensaje contiene lenguaje ofensivo. Corrígelo para enviarlo.");
          return;
        }

        historial.push({
          usuario: "Tú",
          perfil: "/assets/productos/clientes/ninaliliam-anonas/nopfp.jpg", 
          mensaje
        });

        localStorage.setItem(storageKey, JSON.stringify(historial));
        renderHistorial();
        input.value = "";
      })
      .catch(err => {
        console.error("Error verificando mensaje:", err);
        alert("No se pudo validar el mensaje. Intenta de nuevo.");
      });
  });
});




  // ✅ Guarda el marcador correctamente para el buscador
  config.markers = config.markers || [];
  config.markers.push({ marker, punto });

  // Actualiza el tamaño del icono al hacer zoom
  map.on('zoom', () => {
    const metersPerPixelNow = metrosPorPixelEnZoom(map.getZoom(), punto.lat);
    const newSize = radiusMeters / metersPerPixelNow * 2;
    marker.setIcon(createClienteIcon(newSize));
  });




        } else {



          // emprendedores y proveedores círculo con popup normal
          const circleMarker = L.circle([punto.lat, punto.lng], {
            color: config.color,
            fillColor: config.color,
            fillOpacity: 0.7,
            radius: config.radius
          })
          .bindPopup(`
            <div style="display: flex; align-items: center;">
              <img src="${punto.perfil}" alt="Perfil" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover; margin-right: 10px;">
              <div>
                <h3 style="margin: 0; font-weight: 700; color: ${config.color};">${punto.producto}</h3>
                <p style="margin: 2px 0 6px; font-weight: 500; font-size: 1.1em;">${punto.nombre}</p>
                <p style="margin: 0; font-style: italic; color: #aaa;">Tipo: ${cat}</p><br>
                <button onclick="openModal('${punto.nombre}', '${cat}', \`${punto.detalle}\`, '${punto.perfil}', '${punto.producto}', '${punto.facebook}', '${punto.ig}')">Maximizar</button>
              </div>
            </div>
          `)
          .addTo(config.layerGroup)
            .on('click', () => {
            map.setView([punto.lat, punto.lng], map.getZoom(), { animate: true });
          });

          // MARCADOR PARA BUSCADOR
            config.markers = config.markers || [];
            config.markers.push({ marker: circleMarker, punto });


        }
      });
    })
    .catch(err => console.error(`Error cargando ${cat}:`, err));
});



  // Leyenda y funciones
  let activeCat = null;

  const legendItems = document.querySelectorAll('#legend div[data-cat]');
  legendItems.forEach(item => {
    item.addEventListener('click', () => {
      const cat = item.getAttribute('data-cat');

      if (cat === 'all') {
        showAll();
        activeCat = null;
        removeActiveClass();
      } else {
        if (activeCat === cat) {
          showAll();
          activeCat = null;
          removeActiveClass();
        } else {
          showOnly(cat);
          activeCat = cat;
          removeActiveClass();
          item.classList.add('active');
        }
      }
    });
  });

  function showAll() {
    Object.keys(categorias).forEach(c => {
      map.addLayer(categorias[c].layerGroup);
    });
  }

  function showOnly(cat) {
    Object.keys(categorias).forEach(c => {
      if (c === cat) {
        map.addLayer(categorias[c].layerGroup);
      } else {
        map.removeLayer(categorias[c].layerGroup);
      }
    });
  }

  function removeActiveClass() {
    legendItems.forEach(i => i.classList.remove('active'));
  }
</script>



<!-- SCRIP MAPA -->


<!-- SCRIPT BUSCADOR -->

<script>
function filtrarMarcadores(texto) {
  texto = texto.trim().toLowerCase();

  if (texto === "") {
    // Mostrar todos si no hay texto
    Object.keys(categorias).forEach(cat => {
      const config = categorias[cat];
      if (!config.markers) return;

      config.markers.forEach(({ marker }) => {
        if (!map.hasLayer(marker)) map.addLayer(marker);
      });
    });
    return;
  }

  let algunoMostrado = false;

  Object.keys(categorias).forEach(cat => {
    const config = categorias[cat];
    if (!config.markers) return;

    config.markers.forEach(({ marker, punto }) => {
      const nombre = punto.nombre.toLowerCase();
      const producto = punto.producto.toLowerCase();

      const coincide = nombre.includes(texto) || producto.includes(texto);

      if (coincide) {
        if (!map.hasLayer(marker)) map.addLayer(marker);
        algunoMostrado = true;
      } else {
        if (map.hasLayer(marker)) map.removeLayer(marker);
      }
    });
  });

  if (!algunoMostrado) {
    alert("No se encontró ningún resultado para: " + texto);
  }
}

// ESCUCHA ENTER
const inputBusqueda = document.getElementById('searchInput');
inputBusqueda.addEventListener('keyup', (e) => {
  if (e.key === "Enter") {
    filtrarMarcadores(e.target.value);
  }
});

// ESCUCHA VACÍO: restablece todo en tiempo real
inputBusqueda.addEventListener('input', (e) => {
  if (e.target.value.trim() === "") {
    filtrarMarcadores("");
  }
});
</script>



<!-- SCRIPT BUSCADOR -->

</body>
</html>
